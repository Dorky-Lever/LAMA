<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Main config file</title>
	<meta name="generator" content="Zim 0.65">
	<meta name="viewport" content="width=device-width">
	<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:300&subset=latin,greek,latin-ext' rel='stylesheet' type='text/css'> -->
	<![if !IE]>
	<!-- comment out for IE since it spams the user with warnings -->
	<script type='text/javascript' src='http://code.jquery.com/jquery-1.7.1.js'></script>
	<script type='text/javascript'>
		$(window).load(function(){$("#navigation").height( $("#content").height()+65 );});
	</script>
	<![endif]>
	<style>
		*, *:before, *:after {
  -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
		}
		body, html {
			height:100%;
			font-family:'Open Sans', sans-serif;
			line-height:1.5em;
			font-weight:300;
			background-color:#FAFAFA;
			text-rendering:geometricPrecision;
			margin:0;
			padding:0;
		}
		.wrapper {
			height:100%;
			padding: 1.25em;
			margin: .5em;
		}
		#navigation {
			background-color: #F3F3F3;
			border-right:1px solid #EAEAEA;
			padding: 1.25em;
		}
		

		#content {
			padding: 1.25em;
			margin-bottom: .5em;
			
		}
		#navigation ul {
			margin-top:0;
			margin-bottom:0;
			padding-left:40px;
		}
		#navigation li {
			list-style-type:none;
		}
		#navigation a {
			text-decoration:none;
			color:gray;
		}
		#navigation strong {
			color: #6E1308;
			font-weight:400;
		}
		#navigation a:hover {
			text-decoration:underline;
		}
		#content h1:nth-child(1) {
			margin-top:0;
		}
		h1,h2,h3,h4,h5,h6 {
			color: #6E6408;
			font-weight:300;
		}
		
			
		#content a {
			color :#6E1308;
		}
		#content a {
			text-decoration: none;
		}
		#content a:hover {
			text-decoration: underline;
		}
		#content a:active {
			text-decoration: underline;
		}
		#content strike {
			color: grey;
		}
		#content u {
			text-decoration: none;
			background-color: yellow;
		}
		#content tt {
			color: #6E1308;
		}
		#content pre {
			color: #6E1308;
			margin-left: 20px;
		}
		.backlinks {
			color:gray;
		}
		hr.footnotes {
			width: 20%;
			margin-left: 0;
		}

	@media (min-width: 47.5em ) and (orientation: landscape) {
	#content { margin-right: 19.5em; }

	#navigation { position: absolute; top: 0; right: 0; width: 18.75em;}   
	}
		

	</style>
</head>
<body>
	<div class="wrapper">
		<div id="navigation"> <ul>
<li><a href="file:///home/neil/git/lama/docs/LAMA_documentation.html" title="LAMA documentation" class="page">LAMA documentation</a>
<ul>
<li><a href="../Config_files.html" title="Config files" class="page">Config files</a>
<ul>
<li><b>Main config file</b></li>
</ul>
</li>
<li><a href="../Creating_a_population_average.html" title="Creating a population average" class="page">Creating a population average</a></li>
<li><a href="../Getting_started.html" title="Getting started" class="page">Getting started</a></li>
<li><a href="../Known_issues_-_furure_plans.html" title="Known issues - furure plans" class="page">Known issues - furure plans</a></li>
<li><a href="../Quick_start.html" title="Quick start" class="page">Quick start</a></li>
<li><a href="../Running_phenotype_detection.html" title="Running phenotype detection" class="page">Running phenotype detection</a></li>
<li><a href="../Statistics.html" title="Statistics" class="page">Statistics</a></li>
<li><a href="../Trouble_shooting.html" title="Trouble shooting" class="page">Trouble shooting</a></li>
<li><a href="../visualising_results.html" title="visualising results" class="page">visualising results</a></li>
<li><a href="../Workflow.html" title="Workflow" class="page">Workflow</a></li>
</ul></li>
</ul>
 </div>
		<div id="content">
			<h1>Main config file <a name='LAMA documentation:Config files:Main config file'></a></h1>

			<p>
Created Thursday 28 January 2016
</p>

<p>
The main config file is used for running lama from start to scratch<br>
Some full example files to get started with can be found in LAMA/example_config_files
</p>

<h2>Main section</h2>

<p>
This section, located at the top of the file, describes the paths to the data, how to pad the data and various other options.
</p>

<div class="zim-object">
<pre class="brush: python;">
1&nbsp;---
2&nbsp;############################ Config file v1 for the MRC Harwell Registration pipeline###############
3&nbsp;## This file is in YAML format - http://www.yaml.org/                                             ##
4&nbsp;## Use spaces for indentations. Do not use tabs. It helps to edit in an IDE such as PyCharm                        						  ##
5&nbsp;##'true' and 'false' must be quoted within elastix param sections or python interperets them as 'True' and 'False'   		##
6&nbsp;#################################################################################
7&nbsp;
8&nbsp;inputvolumes_dir: inputs
9&nbsp;
10&nbsp;# The Fixed volume
11&nbsp;fixed_volume: target/301015_deformable_to_8_rescaled_8bit.nrrd
12&nbsp;fixed_mask: target/mask_cleaned.nrrd
13&nbsp;label_map_path: target/seg_cleaned.nrrd
14&nbsp;organ_names: organ_names.txt
15&nbsp;
16&nbsp;# Pad the volumes to the size of the largest. Options (true/dimensions to pad to in x, y, z - eg [300,256,240])
17&nbsp;pad_dims: [210, 275, 404]
18&nbsp;
19&nbsp;# Number of cpu cores to use
20&nbsp;threads: 30
21&nbsp;
22&nbsp;# true for creating an average. false for phenotype detection Options (true/false)
23&nbsp;generate_new_target_each_stage: false
24&nbsp;
25&nbsp;# normalise final output to a region of background noise [z,y,x], [z, y, x]
26&nbsp;background_roi_zyx_norm: [[35, 200, 130], [45, 210, 140]]
27&nbsp;
28&nbsp;generate_deformation_fields: deformable_to_64
29&nbsp;	</pre>
</div>

<br>

<p>
<b>inputvolumes_dir</b><br>
Required: false (if not present, LAMA will look for a folder named 'inputs' in theproject directory)<br>
this is a path to a folder containg input volumes
</p>

<p>
<b>pad_dims</b><br>
Required:  true<br>
If set to <tt>true</tt>, the input images, target, mask, and labelmap will be zero-padded such that each dimension equals the size of the largest correspomding dimension of the input images or target
</p>

<p>
Or to set to a predefined size , add the required x,y,z dimensions as bellow<br>
example   pad_dims: [300,200,180]  NOTE: This is x, y, z ! Will change to z, y, x to be consistent across the pipeline
</p>

<p>
<b>threads</b><br>
Required: false<br>
The number of cpu threads to use for the elastix registration<br>
Default: use all available threads
</p>

<p>
<b>skip_transform_inversion</b><br>
if transform inversion is not needed, set to true<br>
Deafault: false
</p>

<p>
<b>generate_new_target_each_stage</b><br>
Required: true<br>
for poulation average creation set to t<tt>rue</tt>.<br>
For phenotype detection, set to f<tt>alse</tt> 
</p>

<p>
<b>background_roi_zyx_norm</b><br>
required: false<br>
A region of interest from which to generate mean background noise level.<br>
This is used to remove background from the normalised images before doing intensity analysis.<br>
Example <a href="./35,_200,_130],_[45,_210,_140.html" title="35, 200, 130], [45, 210, 140" class="page">35, 200, 130], [45, 210, 140</a> . The first list defines the start of the ROI z, y, x coordinates. The second list defines the roi end coordinates
</p>

<p>
<b>generate_deformation_fields</b><br>
required: false (No deformation fields will be generated if set to <tt>false or is absent)</tt>
</p>

<p>
This option defines how deformation fields and associated spatial jacobians are generated.<br>
Generating jacobians from the early stages of registration can give information on large scale differences between controls and mutants<br>
Generating jacobians from later stages of registration, after large scale differences have been accounted for can uncover more subtle differences. 
</p>

<p>
The following entry in the config file would generate three sets of deformation fields and jacobians. <br>
These would be:
</p>

<pre>
generate_deformation_fields: 
    full: [deformable_128, deformable_64, deformable_32, deformable_16, deformable_8)
    coarse: [deformable_128, deformable_to_64, deformable_32]
    fine: [deformable_32, deformable_to_8]

</pre>
<p>
<ul>
<li>Full - The whole deformable (non-linear) stage</li>
<li>Coarse- The inital deformable stages (obtaining course differences)</li>
<li>fine- The final deformable stages (obtaining subtle differences) </li>
</ul>
</p>

<p>
<b>skip_transform_inversion:</b><br>
required: false<br>
default: true<br>
Inversion of the elastix parameter files can sometimes take a significant amount of time.<br>
If you do not need inverted label maps or inverted stats overlays you can set this to true. Otherwise set to false, or exlude from the file
</p>

<h2>Global registration parameters section</h2>

<p>
Parameters here are applied to all stages of registration <br>
See the <a href="http://elastix.isi.uu.nl/doxygen/index.html" title="elastix documentation" class="http">elastix documentation</a> for avaiable parameters 
</p>

<div class="zim-object">
<pre class="brush: python;">
1&nbsp;################################### Global registration parameters, applied to all stages ##############################
2&nbsp;global_elastix_params:
3&nbsp;	FixedInternalImagePixelType: short
4&nbsp;	MovingInternalImagePixelType: short
5&nbsp;	FixedImageDimension: 3
6&nbsp;	MovingImageDimension: 3
7&nbsp;	UseDirectionCosines: 'true'
8&nbsp;	FixedImagePyramid: FixedSmoothingImagePyramid
9&nbsp;	MovingImagePyramid: MovingSmoothingImagePyramid
10&nbsp;	ResultImagePixelType: float
11&nbsp;	ResultImageFormat: nrrd
12&nbsp;	CompressResultImage: 'true'
13&nbsp;	Interpolator: BSplineInterpolator
14&nbsp;	ResampleInterpolator: FinalBSplineInterpolator
15&nbsp;	Resampler: DefaultResampler
16&nbsp;	NumberOfHistogramBins: 32
17&nbsp;	HowToCombineTransforms: Compose
18&nbsp;	NewSamplesEveryIteration: 'true'
19&nbsp;	ImageSampler: RandomCoordinate
20&nbsp;	FinalBSplineInterpolationOrder: 3
21&nbsp;	DefaultPixelValue: 0
22&nbsp;	WriteTransformParametersEachIteration: 'false'
23&nbsp;	WriteResultImage: 'true'
24&nbsp;	AutomaticScalesEstimation: 'true'
25&nbsp;	AutomaticTransformInitialization: 'true'
26&nbsp;
</pre>
</div>

<br>
<br>

<h2>Registration schedule section</h2>

<p>
Each registration stage is defined by a  <tt>- stage_id: stage name </tt>section
</p>

<p>
The following schedule defines a multistep registration with:<br>
<ul>
<li>rigid</li>
<li>affine</li>
<li>deformable (5 resolutions)</li>
</ul>
</p>

<p>
<tt>inherit_elx_params: name_of_stage</tt><br>
Will make that stage inherit parameters from anaither previos stage. Any parameter specified in the new stage will overide the inherited paramters.
</p>

<div class="zim-object">
<pre class="brush: python;">
1&nbsp;################################ Stage-specific registration parameters ################################################
2&nbsp;registration_stage_params:
3&nbsp;
4&nbsp;#### Rigid #############################################################################################################
5&nbsp;    
6&nbsp;	- stage_id: rigid
7&nbsp;	  elastix_parameters:
8&nbsp;		Metric: AdvancedNormalizedCorrelation
9&nbsp;		Registration: MultiResolutionRegistration
10&nbsp;		MaximumNumberOfIterations: 600
11&nbsp;		NumberOfResolutions: 1
12&nbsp;		NumberOfSpatialSamples: 20000
13&nbsp;		FixedKernelBSplineOrder: 1
14&nbsp;		MovingKernelBSplineOrder: 3
15&nbsp;		Transform: EulerTransform
16&nbsp;		Optimizer: AdaptiveStochasticGradientDescent
17&nbsp;		Metric: AdvancedNormalizedCorrelation
18&nbsp;		SP_a: [1000.0, 1000.0, 500.0, 500.0]
19&nbsp;		SP_alpha: 0.602
20&nbsp;		SP_A: 50.0
21&nbsp;		FixedLimitRangeRatio: 0.0
22&nbsp;		MovingLimitRangeRatio: 0.0
23&nbsp;		FixedKernelBSplineOrder: 1
24&nbsp;		MovingKernelBSplineOrder: 3
25&nbsp;		UseDifferentiableOverlap: 'false'
26&nbsp;        
27&nbsp;
28&nbsp; #### Affine #############################################################################################################
29&nbsp;
30&nbsp;	- stage_id: affine
31&nbsp;	  elastix_parameters:
32&nbsp;		MaximumNumberOfIterations: 600
33&nbsp;		Registration: MultiResolutionRegistration
34&nbsp;		NumberOfResolutions: 1
35&nbsp;		Optimizer: AdaptiveStochasticGradientDescent
36&nbsp;		Transform: AffineTransform
37&nbsp;		Metric: AdvancedNormalizedCorrelation
38&nbsp;		NumberOfSpatialSamples: 20000
39&nbsp;
40&nbsp;
41&nbsp;#### Deformable registrations. Generate deformation fields etc #################################
42&nbsp;    
43&nbsp;	- stage_id: deformable_128
44&nbsp;	  elastix_parameters:
45&nbsp;		Registration: MultiResolutionRegistration
46&nbsp;		NumberOfResolutions: 1
47&nbsp;		NumberOfSpatialSamples: 20000
48&nbsp;		NumberOfGradientMeasurements: 10
49&nbsp;		NumberOfSamplesForExactGradient: 20000
50&nbsp;		NumberOfJacobianMeasurements: 4000
51&nbsp;		MaximumNumberOfIterations: 150
52&nbsp;		AutomaticParameterEstimation: 'true'
53&nbsp;		UseAdaptiveStepSizes: 'true'
54&nbsp;		ASGDParameterEstimationMethod: DisplacementDistribution
55&nbsp;		Optimizer: AdaptiveStochasticGradientDescent
56&nbsp;		Transform: BSplineTransform
57&nbsp;		Metric: AdvancedMattesMutualInformation
58&nbsp;		FinalGridSpacingInVoxels: 128
59&nbsp;		MaximumStepLength: 2.0
60&nbsp;
61&nbsp;	- stage_id: deformable_64
62&nbsp;	  inherit_elx_params: deformable_to_128
63&nbsp;	  elastix_parameters:
64&nbsp;		MaximumNumberOfIterations: 150
65&nbsp;		FinalGridSpacingInVoxels: 64
66&nbsp;		MaximumStepLength: 2.0
67&nbsp;
68&nbsp;	- stage_id: deformable_32
69&nbsp;	  inherit_elx_params: deformable_to_64
70&nbsp;	  elastix_parameters:
71&nbsp;		MaximumNumberOfIterations: 150
72&nbsp;		FinalGridSpacingInVoxels: 32
73&nbsp;		MaximumStepLength: 2.0
74&nbsp;
75&nbsp;	- stage_id: deformable_16
76&nbsp;	  inherit_elx_params: deformable_to_32
77&nbsp;	  elastix_parameters:
78&nbsp;		Registration: MultiMetricMultiResolutionRegistration
79&nbsp;		Metric: [AdvancedMattesMutualInformation, TransformRigidityPenalty]
80&nbsp;		NumberOfResolutions: 1
81&nbsp;		FinalGridSpacingInVoxels: 16
82&nbsp;		MaximumStepLength: 1.0
83&nbsp;		RigidityPenaltyWeight: 0.1
84&nbsp;
85&nbsp;	- stage_id: deformable_8
86&nbsp;	  inherit_elx_params: deformable_to_16
87&nbsp;	  elastix_parameters:
88&nbsp;		FinalGridSpacingInVoxels: 8
89&nbsp;		MaximumStepLength: 1.0
90&nbsp;		RigidityPenaltyWeight: 0.1</pre>
</div>



			<br>
			<span class="backlinks">
				<hr class='footnotes'>
				<b>Backlinks:</b>
				<a href='file:///home/neil/git/lama/docs/LAMA_documentation.html'>LAMA documentation</a>
				
				<a href='../Trouble_shooting.html'>LAMA documentation:Trouble shooting</a>
				
				<a href='../Creating_a_population_average.html'>LAMA documentation:Creating a population average</a>
				
				<a href='../Config_files.html'>LAMA documentation:Config files</a>
				<br /><br />
			</span>

			
		</div>
	</div>
</body>
</html>

